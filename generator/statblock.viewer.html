<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Kreaturen-Datenbank – Finales Layout</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root{--pf-red:#7e1f1f;--ink:#1c1c1c;--muted:#565656;--chip:#ece6e0;--bg:#f6f2ee;--rule:#d9cfc7}
  html,body{margin:0;background:var(--bg    );color:var(--ink);font:400 12px/1.35 "Roboto Condensed",Arial,system-ui;height:100%}
  
  .app-layout{display:grid;grid-template-columns:240px 1fr;grid-template-rows:auto 1fr;height:100vh;gap:0 14px;}
  
  .header{grid-column:1 / -1;padding:10px 14px;background:#fff;border-bottom:1px solid var(--rule);display:flex;align-items:center;gap:14px;}
  
  .sidebar{grid-column:1;grid-row:2;background:#fff;border-right:1px solid var(--rule);padding:10px;overflow-y:auto;}
  .sidebar h2{font:700 11px/1 "Roboto Condensed";letter-spacing:.12em;text-transform:uppercase;color:var(--pf-red);margin:0 0 10px;}
  .sidebar ul{margin:0;padding:0;list-style:none;}
  .sidebar li{padding:6px 8px;border-radius:4px;cursor:pointer;margin-bottom:2px;}
  .sidebar li:hover{background:var(--chip);}
  .sidebar li.active{background:var(--pf-red);color:#fff;font-weight:700;}

  .main-content{grid-column:2;grid-row:2;padding:14px 0;overflow-y:auto;}
  
  #out{background:#fff;border:1px solid var(--rule);max-width:820px;}
  #placeholder{padding:20px;text-align:center;color:var(--muted);border:2px dashed var(--rule);border-radius:8px;max-width:820px;}

  button, .file-label{background:var(--pf-red);color:#fff;border:0;border-radius:5px;padding:6px 12px;font:700 12px/1 "Roboto Condensed";letter-spacing:.04em;cursor:pointer;display:inline-block;}
  input[type="file"]{display:none;}

  /* Statblock-Stile */
  .head{background:linear-gradient(#f1e7e0,#eaddd3);border-bottom:2px solid var(--pf-red);padding:8px 10px}
  .name{font:700 19px/1.1 "Roboto Condensed";letter-spacing:.01em;margin:0}
  .line{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:4px}
  .chip{background:var(--chip);border:1px solid var(--rule);color:#1b1b1b;padding:2px 7px;border-radius:999px;font:700 10.5px/1 "Roboto Condensed";text-transform:uppercase;letter-spacing:.08em;font-variant:small-caps;}
  
  .hg-badge{background:var(--pf-red);color:#fff;padding:3px 8px;border-radius:999px;font-weight:700;font-size:11px;letter-spacing:.06em;text-transform:uppercase;}

  .desc{font-family:"Crimson Text",serif;font-size:12px;line-height:1.35;color:#2a2a2a;margin-top:6px;font-style:italic}
  .sec{padding:8px 10px;border-top:1px solid var(--rule)}
  .sec h3{font:700 11px/1 "Roboto Condensed";letter-spacing:.12em;text-transform:uppercase;color:var(--pf-red);margin:0 0 6px}
  .row{margin:2px 0}
  .muted{color:var(--muted)}
  .attblock .attline{margin:2px 0}
  .icon-shield{display:inline-flex;align-items:center;gap:4px;vertical-align:middle;margin-left:4px;}
  .icon-shield svg{width:14px;height:14px;fill:black!important;vertical-align:middle;}
  .rettungswuerfe{display:flex;gap:8px;flex-wrap:wrap;}

  .loot-category { margin-top: 4px; }
  .loot-category b { font-weight: 700; }
  .loot-item { display: block; margin-left: 10px; padding-left: 10px; border-left: 2px solid var(--chip); margin-top: 2px; }
  .loot-item .muted { color: var(--muted); }

</style>
</head>
<body>

<div class="app-layout">
  <header class="header">
    <label for="file-loader" class="file-label">JSON-Datei laden</label>
    <input type="file" id="file-loader" accept=".json">
    <span id="file-name" class="muted">Keine Datei ausgewählt.</span>
  </header>

  <aside class="sidebar">
    <h2>Gegner</h2>
    <ul id="creature-list"></ul>
  </aside>

  <main class="main-content">
    <div id="out">
      <div id="placeholder">
        <h3>Willkommen!</h3>
        <p>Bitte laden Sie eine JSON-Datei mit einer Liste von Gegnern, um zu beginnen.</p>
        <p>Die Datei muss ein Array von Gegner-Objekten sein, z.B. <code>[ { "name": "Goblin", ... }, { "name": "Oger", ... } ]</code></p>
      </div>
    </div>
  </main>
</div>

<script>
// --- Globale Variablen ---
const $ = s => document.querySelector(s);
let creatureData = [];

// --- Kernfunktionen ---

function handleFileLoad(event) {
  const file = event.target.files[0];
  if (!file) return;
  $('#file-name').textContent = file.name;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) throw new Error("Die JSON-Datei muss ein Array von Gegner-Objekten enthalten.");
      creatureData = data;
      populateSidebar(creatureData);
      $('#out').innerHTML = `<div id="placeholder"><p>Daten geladen. Bitte wählen Sie einen Gegner aus der Liste links.</p></div>`;
    } catch (err) {
      alert(`Fehler beim Lesen der Datei: ${err.message}`);
      creatureData = [];
      populateSidebar([]);
      $('#out').innerHTML = `<div id="placeholder"><p class="error">Fehler: ${err.message}</p></div>`;
    }
  };
  reader.readAsText(file);
}

function populateSidebar(creatures) {
  const list = $('#creature-list');
  list.innerHTML = '';
  creatures.forEach((creature, index) => {
    const li = document.createElement('li');
    li.textContent = creature.name || `Unbenannter Gegner ${index + 1}`;
    li.dataset.index = index;
    li.addEventListener('click', () => {
      document.querySelectorAll('#creature-list li').forEach(item => item.classList.remove('active'));
      li.classList.add('active');
      renderStatblock(creature);
    });
    list.appendChild(li);
  });
}

function renderStatblock(d) {
  const res = parseRes(d.besonderheiten || []);
  const traits = Array.isArray(d.traits) ? d.traits : [];
  const srNote = formatNote(d.sr_bemerkung);
  const aswNote = formatNote(d.asw_bemerkung);
  const paNote = formatPaNote(d.pa_bemerkung);
  const hasBes = res.imm.length || res.res.length || res.weak.length || res.other.length;

  $('#out').innerHTML = `
    <div class="head">
      <div class="name">${txt(d.name)}</div>
      <div class="line">
        ${d.hg != null ? `<span class="hg-badge">HG ${txt(d.hg)}</span>` : ''}
        ${d.typ ? `<span class="chip">${d.typ}</span>` : ''}
        ${traits.map(t => `<span class="chip">${t}</span>`).join('')}
        ${d.ep != null ? `<span class="chip">${d.ep} EP</span>` : ''}
      </div>
      ${d.beschreibung ? `<div class="desc">${d.beschreibung}</div>` : ''}
    </div>
    <div class="sec">
      <div class="row"><b>Lebenspunkte</b> ${txt(d.lp)}</div>
      <div class="row"><b>Bewegung</b> ${fmtBew(d.bew)}; <b>INI</b> ${plusify(d.ini)}</div>
    </div>
    <div class="sec">
      <h3>Verteidigung</h3>
      <div class="row"><b>Abwehr Nahkampf (PA)</b> ${txt(d.pa)}${paNote}</div>
      <div class="row"><b>Abwehr Fernkampf (ASW)</b> ${txt(d.asw)}${aswNote}</div>
      <div class="row"><b>Schadensreduktion</b> ${txt(d.sr)}${srNote}</div>
      <div class="rettungswuerfe">
        <span><b>Zähigkeit</b> ${plusify(d.rz, true)}</span><span>|</span>
        <span><b>Reflexe</b> ${plusify(d.rr, true)}</span><span>|</span>
        <span><b>Willenskraft</b> ${plusify(d.rw, true)}</span>
      </div>
    </div>
    ${Array.isArray(d.angriffe) && d.angriffe.length ? `<div class="sec"><h3>Angriffe</h3><div class="attblock">${d.angriffe.map(a => `<div class="attline">${naturalAttackLine(a)}</div>`).join('')}</div></div>` : ''}
    ${hasBes ? `<div class="sec"><h3>Besonderheiten</h3>${res.imm.map(x=>`<div class="row">${x}</div>`).join('')}${res.res.map(x=>`<div class="row">${x}</div>`).join('')}${res.weak.map(x=>`<div class="row">${x}</div>`).join('')}${res.other.map(x=>`<div class="row">${x}</div>`).join('')}</div>` : ''}
    <div class="sec"><h3>Beute</h3>${renderLoot(d.beute || [])}</div>
  `;
}

// --- Hilfsfunktionen ---
function txt(x){return (x===null||x===undefined||x==="")?"–":String(x)}
function plusify(v, isSaveDC = false){if(v===undefined||v===null) return "–";if(String(v).toLowerCase()==="immun") return "immun";const n=Number(v); return isNaN(n)?String(v):((n>=0 && !isSaveDC?'+':'')+n);}
function parseRes(bes){const res={imm:[],res:[],weak:[],other:[]};(bes||[]).forEach(s=>{const t=String(s||'').trim();if(/^immun/i.test(t)){let val=t.replace(/^immun(?:ität|itäten)?(?:\s*:\s*|\s+gegen\s*)?/i,'').trim();if(val) res.imm.push(`Immun ${/^gegen\s/i.test(val)?val:('gegen '+val)}`);} else if(/^resistenz/i.test(t)){let val=t.replace(/^resistenzen?|resistenz/i,'').replace(/^(?:\s*:\s*|\s+gegen\s*)?/,'').trim();if(val) res.res.push(`Resistent ${/^gegen\s/i.test(val)?val:('gegen '+val)}`);} else if(/^anfälligkeit/i.test(t)){let val=t.replace(/^anfälligkeiten?|anfälligkeit/i,'').replace(/^(?:\s*:\s*|\s+gegen\s*)?/,'').trim();if(val) res.weak.push(`Anfällig ${/^gegen\s/i.test(val)?val:('gegen '+val)}`);} else {res.other.push(t);}});return res;}
function fmtBew(b){if(!b) return "–";const m=b.match(/^(\d+)(?:\s*\((.+)\))?$/);if(!m) return b;const modes = m[2]? m[2].replace(/,\s*/g,'; ').replace(/vs/gi,'gegen') : '';return modes? `${m[1]}; ${modes}` : m[1];}
function naturalAttackLine(a){const name = (a.name||'Angriff').replace('ß','ss');const bits=[];if(a.to_hit!=null) bits.push(`${plusify(a.to_hit)} zum Treffen`);if(a.schaden!=null) bits.push(`${a.schaden} Schaden`);if(a.zusatz) bits.push(`und ${capitalize(a.zusatz)}`);if(a.reichweite) bits.push(`(${a.reichweite})`);let line = `<b>${name}</b> ${bits.filter(Boolean).join(', ')}`.replace(/\s+,/g,',');if(a.rettungswurf){const r=a.rettungswurf;const mis = r.bei_misserfolg ? r.bei_misserfolg : 'negative Wirkung';const dur = r.dauer ? ` Dauer: ${r.dauer}.` : '';line += ` (Rettungswurf ${r.art} ${txt(r.zw)} oder ${mis}.${dur})`;}if(a.anzahl!=null) line += ` [x${a.anzahl}]`;return line;}
function capitalize(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }

function formatPaNote(paBemerkung) {
  if (!Array.isArray(paBemerkung) || paBemerkung.length === 0) return '';
  const textNotes = paBemerkung.filter(note => typeof note === 'string');
  const shieldNote = paBemerkung.find(note => typeof note === 'object' && note.icon === 'shield');
  
  let shieldPart = '';
  if (shieldNote) {
    shieldPart = `<span class="icon-shield" title="${shieldNote.description || ''}">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048-.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56z"/></svg>
      ${shieldNote.value || ''}
    </span>`;
  }

  let textPart = '';
  if (textNotes.length > 0  ) {
    textPart = `, (${textNotes.join('; ').replace(/vs/gi, 'gegen')})`;
  }
  
  return shieldPart + textPart;
}

function formatNote(note) {
    if (!note || (Array.isArray(note) && note.length === 0)) return '';
    const noteString = Array.isArray(note) ? note.join('; ') : String(note);
    return noteString.trim() ? ` (${noteString.replace(/vs/gi, 'gegen')})` : '';
}

// KORRIGIERT: Die Kategorisierung basiert nun auf dem `typ`-Feld des Beute-Objekts.
function renderLoot(arr) {
  if (!Array.isArray(arr) || !arr.length) return '<span class="muted">Keine.</span>';

  const treasure = [];
  const equipment = [];
  const harvest = [];

  const formatItemDetails = (item) => {
    let details = [];
    if (item.wert != null) details.push(`Wert ${item.wert}`);
    if (item.anzahl != null) details.push(`${item.anzahl} Stück`);
    return details.length ? ` (${details.join(', ')})` : '';
  };

  arr.forEach(b => {
    if (b.typ === "GM") {
      treasure.push(`${b.wurf} Goldmünzen`);
    } else if (b.wurf) {
      // Bestimme die Kategorie basierend auf dem `typ`-Feld.
      const isHarvestable = b.typ && b.typ.startsWith('Erntbar:');
      const itemString = `<span class="muted">${b.wurf}</span>`;
      
      if (isHarvestable) {
        harvest.push(itemString);
      } else {
        equipment.push(itemString);
      }
    } else { 
      // Fallback für einfache Items ohne Würfelwurf (z.B. nur { "typ": "Dolch", "wert": 2 })
      const isHarvestable = b.typ && b.typ.startsWith('Erntbar:');
      const itemName = isHarvestable ? b.typ.replace(/^Erntbar:\s*/, '') : b.typ;
      const itemString = `${itemName}${formatItemDetails(b)}`;

      if (isHarvestable) {
        harvest.push(itemString);
      } else {
        // Einfache Items ohne Wurf werden als Schatz/Ausrüstung behandelt, nicht als Wurf-Item
        treasure.push(itemString);
      }
    }
  });

  let html = '';
  if (treasure.length > 0) {
    html += `<div class="loot-category"><b>Schatz:</b> ${treasure.join(', ')}</div>`;
  }
  if (equipment.length > 0) {
    html += `<div class="loot-category"><b>Ausrüstung:</b>${equipment.map(e => `<span class="loot-item">${e}</span>`).join('')}</div>`;
  }
  if (harvest.length > 0) {
    html += `<div class="loot-category"><b>Erntbares:</b>${harvest.map(h => `<span class="loot-item">${h}</span>`).join('')}</div>`;
  }
  
  return html || '<span class="muted">Keine.</span>';
}


// --- Event Listener initialisieren ---
$('#file-loader').addEventListener('change', handleFileLoad);

</script>
</body>
</html>
